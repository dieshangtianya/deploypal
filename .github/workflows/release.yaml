name: Deploypal Release
on:
  # Ëá™Âä®ÊâßË°åÂèëÂ∏É‰ªªÂä°ÁöÑËß¶ÂèëÊù°‰ª∂
  push:
    # ÈÖçÁΩÆbetaÂàÜÊîØÔºåÂè™ÊúâÊé®ÈÄÅbetaÂàÜÊîØÊâç‰ºöËß¶Âèë‰ª•‰∏ã‰ªªÂä°
    branches:
      - beta

  # ÊâãÂä®ÊâßË°åÂèëÂ∏É‰ªªÂä°ÁöÑËß¶ÂèëÊù°‰ª∂
  # ËøôÈáå‰ΩøÁî®‰∫Ü‰∏§‰∏™ËæìÂÖ•ÂèÇÊï∞ÔºåÂàÜÂà´ÊòØtarget-branchÂíådry-run
  # ÂÖ∂‰∏≠target-branchÊòØ‰∏ãÊãâÊ°ÜÔºåÁî®Êà∑ÈÄâÊã©masterÊàñbetaÂàÜÊîØ
  # dry-runÊòØÂ∏ÉÂ∞îÂÄºÔºåË°®Á§∫ÊòØÂê¶‰ªÖËØïËøêË°å‰∏çÂÆûÈôÖÂèëÂ∏É
  # ÂÖ∂ÈúÄË¶ÅÁªìÂêàÊ≠•È™§‰∏≠ÁöÑÂà§Êñ≠Êù•ÊâßË°å
  workflow_dispatch:
    inputs:
      target-branch:
        description: "Publish branch(default:master)"
        required: true
        type: choice
        options:
          - master
          - beta
        default: "master"
      dry-run:
        description: "Only trial run, not actual release"
        required: false
        type: boolean

# ÂÆö‰πâ‰ªªÂä°
jobs:
  # ÂÆö‰πârelease‰ªªÂä°
  release:
    # ÂÆö‰πâËøêË°åÁöÑËôöÊãüÊú∫ÁéØÂ¢É
    runs-on: ubuntu-latest
    # ËÆæÁΩÆ‰ªªÂä°Á∫ßÂà´ÊùÉÈôê
    permissions:
      contents: write  # ÂàõÂª∫Ê†áÁ≠æ
      issues: write    # ÂàõÂª∫issueËØÑËÆ∫ÔºàÂ§±Ë¥•ÈÄöÁü•Ôºâ
      pull-requests: write # Â¶ÇÊûúÈúÄË¶ÅÂú®PR‰∏≠ËØÑËÆ∫
    # ËÆæÁΩÆ‰ªªÂä°Á∫ßÂà´ÂèòÈáèÔºåÂèØ‰æõÂÖ∂‰ªñ‰Ωú‰∏öËÆøÈóÆ
    outputs:
      duration_seconds: ${{ steps.end-workflow.outputs.duration_seconds }}
      start_time: ${{ steps.end-workflow.outputs.start_time }}
      end_time: ${{ steps.end-workflow.outputs.end_time }}
    timeout-minutes: 30
    # ËÆæÁΩÆ‰ªªÂä°ÁöÑËß¶ÂèëÊù°‰ª∂ÔºåÂè™ËÉΩÊòØbetaÂêàÂπ∂ÂêéËá™Âä®ÊâßË°åÔºåÊàñËÄÖÈÄâÊã©ÂàÜÊîØÊâãÂä®ÊâßË°å, ÂÖ∂‰ªñÊù°‰ª∂‰∏çÊâßË°å
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/beta') ||
      (github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.target-branch == 'master' || github.event.inputs.target-branch == 'beta'))
    # ÂÆö‰πâ‰ªªÂä°ÁöÑÊâßË°åÊ≠•È™§
    steps:
      # Á¨¨Èõ∂Ê≠•ÔºöÊâìÂç∞ÂºÄÂßãÊó•Âøó
      - name: Start workflow
        id: start-workflow
        run: |
          echo "========================================"
          echo "üöÄ Start to release"
          echo "üì¶ Project: ${{ github.repository }}"
          echo "üåø Branch: ${{ github.event.inputs.target-branch || github.ref_name }}"
          echo "üìù Committer: ${{ github.sha }}"
          echo "üë§ Trigger: ${{ github.actor }}"
          echo "üïê TriggerTime: $(date)"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ github.event.inputs.target-branch }}" == "master" ]]; then
              echo "üéØ Publish Environment: Production"
            else
              echo "üß™ Publish Environment: Beta Prerelease"
            fi
          else
            echo "üß™ Publish Environment: Beta Prerelease"
          fi
          echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
          echo "========================================"
     
      # Á¨¨‰∏ÄÊ≠•ÔºöÈ™åËØÅÁéØÂ¢ÉÂèòÈáè
      - name: Validate environment
        run: |
            # Ê£ÄÊü•ÂøÖË¶ÅÁöÑsecrets
            if [[ -z "${{ secrets.NPM_TOKEN }}" ]]; then
               echo "‚ùå NPM_TOKEN not set in secrets"
               exit 1
            else
               echo "NPM_TOKEN: ${{ secrets.NPM_TOKEN }}"
               echo "‚úÖEnvironment variables validated"
            fi

      # Á¨¨‰∫åÊ≠•ÔºöÊ£ÄÂá∫‰ª£Á†Å
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ÂøÖÈ°ªÔºÅsemantic-releaseÈúÄË¶ÅÂÆåÊï¥ÁöÑgitÂéÜÂè≤
          # ÊâãÂä®Ëß¶ÂèëÊó∂ÔºåÊãâÂèñtarget-branch‰∏≠ÊåáÂÆöÁöÑÂàÜÊîØ,ÊàñËÄÖËá™Âä®Ëß¶ÂèëÊó∂ÁöÑÂΩìÂâçÂàÜÊîØ
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.target-branch || github.ref }}
          token: ${{ secrets.GH_TOKEN }}
     
      # Á¨¨‰∏âÊ≠•ÔºöËÆæÁΩÆÊâìÂåÖÁéØÂ¢É
      - name: Prepare release environment
        uses: actions/setup-node@v4
        with:
          node-version: "24" # ÈúÄË¶ÅÁöÑNode.jsÁâàÊú¨
      
      # Á¨¨ÂõõÊ≠•ÔºöÈÖçÁΩÆyarnÁºìÂ≠ò
      - name: Yarn Cache configuration
        uses: actions/cache@v3
        id: yarn-cache
        with:
          path: |
            **/.yarn
            **/node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: ${{ runner.os }}-yarn-
      
      # Á¨¨‰∫îÊ≠•ÔºöÂÆâË£Ö‰æùËµñ
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      
      # Á¨¨ÂÖ≠Ê≠•ÔºöÊûÑÂª∫È°πÁõÆ
      - name: Build project
        run: yarn build

      # Á¨¨‰∏ÉÊ≠•: ÊûÑÂª∫È°πÁõÆÂêéÁöÑÂ§ÑÁêÜÂ∑•‰Ωú
      - name: Post-build tasks
        run: yarn build:after

      # Á¨¨ÂÖ´Ê≠•ÔºöÊâßË°åpublish
      - name: Publish NPM package
        if: success() # ÊòéÁ°ÆË¶ÅÊ±ÇÂâçÈù¢Ê≠•È™§ÈÉΩÊàêÂäü
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] && [[ "${{ github.event.inputs.dry-run }}" == "true" ]]; then
            yarn semantic-release-next
          else
            yarn semantic-release
          fi

      # Á¨¨‰πùÊ≠•ÔºåÊâìÂç∞ÊâßË°åÁªìÊûú
      - name: End workflow
        id: end-workflow
        if: always()  # Á°Æ‰øùÂç≥‰ΩøÂ§±Ë¥•‰πüÊâßË°å
        run: |
          end_time=$(date +%s)
          start_time=${{ steps.start-workflow.outputs.start_time }}
          duration=$((end_time - start_time))
          echo "duration_seconds=$duration" >> $GITHUB_OUTPUT
          echo "end_time=$end_time" >> $GITHUB_OUTPUT
          echo "start_time=$start_time" >> $GITHUB_OUTPUT

          echo "========================================"
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "‚úÖ Project released successfully"
          else
            echo "‚ùå Project release failed"
          fi
          echo "üïíTotal time: ${duration} seconds"
          echo "========================================"
